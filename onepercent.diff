From 506a5a9b9508b84bdef33be3c3c716b897249377 Mon Sep 17 00:00:00 2001
From: Oskar Neumann <oskar.neumann@me.com>
Date: Thu, 9 Nov 2017 23:05:18 +0100
Subject: [PATCH] removing 1% rule for debugging purposes

---
 culfw/clib/clock.c      | 3 ---
 culfw/clib/fht.c        | 2 +-
 culfw/clib/rf_maico.c   | 8 --------
 culfw/clib/rf_moritz.c  | 7 -------
 culfw/clib/rf_receive.c | 2 +-
 culfw/clib/rf_send.c    | 7 +------
 6 files changed, 3 insertions(+), 26 deletions(-)

diff --git a/culfw/clib/clock.c b/culfw/clib/clock.c
index ebd6b4f..8f2673f 100644
--- a/culfw/clib/clock.c
+++ b/culfw/clib/clock.c
@@ -200,9 +200,6 @@ Minute_Task(void)
     LED_TOGGLE();
 #endif
 
-  if (credit_10ms < MAX_CREDIT) // 10ms/1s == 1% -> allowed talk-time without CD
-    credit_10ms += 1;
-
 #ifdef HAS_ONEWIRE
   // if HMS Emulation is on, check the HMS timer
   #ifdef USE_HW_AUTODETECT
diff --git a/culfw/clib/fht.c b/culfw/clib/fht.c
index 3233106..9d1e6e1 100644
--- a/culfw/clib/fht.c
+++ b/culfw/clib/fht.c
@@ -321,7 +321,7 @@ fhtsend(char *in)
       for(uint8_t i = 0 ; i < FHT_8V_NUM; i++ )
         if(fht8v_buf[2*i] != FHT_8V_DISABLED )
           cnt++;
-      credit_10ms += (4*fht8v_ctsync);   // should be 3.75 = 75ms / 2 / 10
+      credit_10ms = MAX_CREDIT;   // should be 3.75 = 75ms / 2 / 10
       
     } else {                           // Valve position
       uint8_t idx = (hb[0]-fht_hc0)*2;
diff --git a/culfw/clib/rf_maico.c b/culfw/clib/rf_maico.c
index bc21ecc..7b333dc 100644
--- a/culfw/clib/rf_maico.c
+++ b/culfw/clib/rf_maico.c
@@ -186,14 +186,6 @@ maico_sendraw(uint8_t *dec)
 {
   uint8_t hblen = 0x0b;
   //1kb/s = 1 bit/ms. we send 1 sec preamble + hblen*8 bits
-  uint32_t sum = (hblen*8)/10;
-  if (credit_10ms < sum) {
-    MULTICC_PREFIX();
-    DS_P(PSTR("LOVF\n\r"));
-    return;
-  }
-  credit_10ms -= sum;
-
 
 #ifdef USE_RF_MODE
   change_RF_mode(RF_mode_maico);
diff --git a/culfw/clib/rf_moritz.c b/culfw/clib/rf_moritz.c
index d84022b..69dddaf 100644
--- a/culfw/clib/rf_moritz.c
+++ b/culfw/clib/rf_moritz.c
@@ -258,13 +258,6 @@ moritz_sendraw(uint8_t *dec, int longPreamble)
 {
   uint8_t hblen = dec[0]+1;
   //1kb/s = 1 bit/ms. we send 1 sec preamble + hblen*8 bits
-  uint32_t sum = (longPreamble ? 100 : 0) + (hblen*8)/10;
-  if (credit_10ms < sum) {
-    MULTICC_PREFIX();
-    DS_P(PSTR("LOVF\r\n"));
-    return;
-  }
-  credit_10ms -= sum;
 
 #ifdef USE_RF_MODE
   change_RF_mode(RF_mode_moritz);
diff --git a/culfw/clib/rf_receive.c b/culfw/clib/rf_receive.c
index 85b103f..bb89a0c 100644
--- a/culfw/clib/rf_receive.c
+++ b/culfw/clib/rf_receive.c
@@ -122,7 +122,7 @@ tx_init(void)
   SET_BIT( CC1100_EICR, CC1100_ISC);  // Any edge of INTx generates an int.
 #endif
 
-  credit_10ms = MAX_CREDIT/2;
+  credit_10ms = MAX_CREDIT;
 
   for(int i = 1; i < RCV_BUCKETS; i ++)
     bucket_array[CC_INSTANCE][i].state = STATE_RESET;
diff --git a/culfw/clib/rf_send.c b/culfw/clib/rf_send.c
index b3ccc95..e1eb7f7 100644
--- a/culfw/clib/rf_send.c
+++ b/culfw/clib/rf_send.c
@@ -100,13 +100,8 @@ sendraw(uint8_t *msg, uint8_t sync, uint8_t nbyte, uint8_t bitoff,
 {
   // 12*800+1200+nbyte*(8*1000)+(bits*1000)+800+10000 
   // message len is < (nbyte+2)*repeat in 10ms units.
-  int8_t i, j, sum = (nbyte+2)*repeat + addH + addL;
-  if (credit_10ms < sum) {
-    DS_P(PSTR("LOVF\r\n"));
-    return;
-  }
-  credit_10ms -= sum;
 
+  int8_t i, j = (nbyte+2)*repeat + addH + addL;
   LED_ON();
 
 #if defined (HAS_IRRX) || defined (HAS_IRTX) // Block IR_Reception
-- 
2.8.1

